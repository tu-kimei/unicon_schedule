datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================================================
// ENUMS
// ============================================================================

enum OrderStatus {
  DRAFT
  CONFIRMED
  CANCELLED
}

enum ShipmentStatus {
  DRAFT
  READY
  ASSIGNED
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum StopType {
  PICKUP
  DROPOFF
  DEPOT
  PORT
}

enum VehicleType {
  TRACTOR       // Đầu kéo
  TRAILER       // Mooc
}

enum VehicleStatus {
  IN_USE          // Đang sử dụng
  MAINTENANCE     // Bảo trì
  OUT_OF_SERVICE  // Ngưng hoạt động
}

enum VehicleCompany {
  KHANH_HUY     // Khánh Huy
  UNICON        // Unicon
}

enum DriverStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum EventType {
  STATUS_CHANGE
  EXCEPTION
  NOTE
}

enum PODFileType {
  IMAGE_JPG
  IMAGE_PNG
  DOCUMENT_PDF
}

enum UserRole {
  // Nội bộ
  ADMIN         // Quản trị viên
  ACCOUNTING    // Kế toán
  OPS           // Vận hành nội bộ
  DISPATCHER    // Điều phối
  DRIVER        // Tài xế
  
  // Khách hàng
  CUSTOMER_OWNER    // Chủ hàng
  CUSTOMER_OPS      // Vận hành khách hàng
}

enum UserType {
  INTERNAL      // Nội bộ
  CUSTOMER      // Khách hàng
}

enum DebtType {
  FREIGHT       // Công nợ cước vận chuyển
  ADVANCE       // Công nợ chi hộ
  OTHER         // Công nợ khác
}

enum DebtStatus {
  UNPAID        // Chưa thanh toán
  PAID          // Đã thanh toán
  OVERDUE       // Quá hạn
  CANCELLED     // Đã hủy
}

enum PaymentTermType {
  DAYS          // 20 ngày, 30 ngày
  MONTHS        // 1 tháng, 3 tháng
}

enum StatementFrequency {
  MONTHLY_25    // 1 tháng 1 lần vào ngày 25
  MONTHLY_30    // 1 tháng 1 lần vào ngày 30/31
  WEEKLY        // 1 tuần 1 lần
  BIMONTHLY     // 1 tháng 2 lần vào ngày 15 và 31
}

enum CustomerStatus {
  ACTIVE        // Đang hợp tác
  INACTIVE      // Ngưng hợp tác
}

// ============================================================================
// MODELS
// ============================================================================

model User {
  id          String   @id @default(uuid())
  email       String   @unique
  password    String? // Wasp handles password hashing
  fullName    String
  userType    UserType @default(INTERNAL) // INTERNAL or CUSTOMER
  role        UserRole @default(OPS)
  customerId  String? // Nếu là user khách hàng thì link đến Customer
  isActive    Boolean  @default(true)
  lastLogin   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  customer              Customer?      @relation("CustomerUsers", fields: [customerId], references: [id])
  driver                Driver?
  createdDispatches     Dispatch[]     @relation("AssignedBy")
  createdStatusEvents   ShipmentStatusEvent[]
  uploadedPODs          POD[]
  createdDebts          Debt[]         @relation("DebtCreatedBy")

  @@map("users")
}

model Customer {
  id              String          @id @default(uuid())
  name            String
  email           String          @unique
  phone           String?
  address         String?
  
  // Payment terms
  paymentTermDays Int             @default(30) // Thời hạn công nợ mặc định
  paymentTermType PaymentTermType @default(DAYS)
  
  // Quy định chốt bảng kê
  statementFrequency StatementFrequency? // 1 tháng 1 lần, 1 tuần 1 lần, 1 tháng 2 lần
  
  // Thông tin hóa đơn VAT
  hasVATInvoice   Boolean         @default(false) // Có xuất HĐ VAT
  invoiceName     String?         // Tên trên hóa đơn
  taxCode         String?         // Mã số thuế
  taxAddress      String?         // Địa chỉ thuế
  
  // Trạng thái hợp tác
  status          CustomerStatus  @default(ACTIVE) // Đang hợp tác / Ngưng hợp tác
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  users  User[]  @relation("CustomerUsers") // Các user thuộc khách hàng này
  orders Order[]
  debts  Debt[]

  @@map("customers")
}

model Order {
  id                 String       @id @default(uuid())
  customerId         String
  orderNumber        String       @unique
  description        String?
  totalWeight        Decimal?     @db.Decimal(10, 2)
  totalVolume        Decimal?     @db.Decimal(10, 2)
  specialInstructions String?     @db.Text
  status             OrderStatus  @default(DRAFT)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  deletedAt          DateTime? // Soft delete

  // Relations
  customer  Customer   @relation(fields: [customerId], references: [id])
  shipments Shipment[]

  @@map("orders")
}

model Shipment {
  id                String         @id @default(uuid())
  orderId           String
  shipmentNumber    String         @unique
  currentStatus     ShipmentStatus @default(DRAFT)
  priority          Priority       @default(NORMAL)
  plannedStartDate  DateTime
  plannedEndDate    DateTime
  actualStartDate   DateTime?
  actualEndDate     DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  deletedAt         DateTime? // Soft delete

  // Relations
  order             Order                @relation(fields: [orderId], references: [id])
  stops             ShipmentStop[]
  dispatch          Dispatch?
  statusEvents      ShipmentStatusEvent[]
  pods              POD[]

  @@map("shipments")
  @@index([currentStatus, plannedStartDate])
}

model ShipmentStop {
  id                  String     @id @default(uuid())
  shipmentId          String
  sequence            Int
  stopType            StopType
  locationName        String
  address             String
  contactPerson       String?
  contactPhone        String?
  plannedArrival      DateTime
  plannedDeparture    DateTime
  actualArrival       DateTime?
  actualDeparture     DateTime?
  specialInstructions String?    @db.Text
  createdAt           DateTime   @default(now())

  // Relations
  shipment Shipment @relation(fields: [shipmentId], references: [id])
  pods     POD[]

  @@map("shipment_stops")
  @@index([shipmentId, sequence])
}

model Vehicle {
  id                      String         @id @default(uuid())
  licensePlate            String         @unique
  vehicleType             VehicleType    // Đầu kéo / Mooc
  manufacturingYear       Int?           // Năm sản xuất
  status                  VehicleStatus  @default(IN_USE)
  
  // Hình ảnh giấy tờ
  registrationImages      String[]       @default([]) // Hình đăng ký (multi images)
  inspectionImages        String[]       @default([]) // Hình đăng kiểm (multi images)
  insuranceImages         String[]       @default([]) // Hình bảo hiểm (multi images)
  
  // Ngày hết hạn - Thêm default để migrate được
  operationExpiryDate     DateTime       @default(now()) // Ngày hết hạn vận hành
  inspectionExpiryDate    DateTime       @default(now()) // Ngày hết hạn đăng kiểm
  insuranceExpiryDate     DateTime       @default(now()) // Ngày hết hạn bảo hiểm
  
  // Trực thuộc công ty
  company                 VehicleCompany @default(UNICON) // Khánh Huy / Unicon
  
  currentLocation         String?        // Vị trí hiện tại
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt

  // Relations
  dispatches Dispatch[]

  @@map("vehicles")
}

model Driver {
  id                String       @id @default(uuid())
  userId            String       @unique
  fullName          String
  phone             String
  
  // Thông tin cá nhân
  citizenIdImages   String[]     // CCCD (multi images)
  birthYear         Int?         // Năm sinh
  hometown          String?      // Quê quán
  
  // Bằng lái
  licenseImages     String[]     // Bằng lái (multi images)
  licenseExpiry     DateTime     // Ngày hết hạn giấy phép
  
  status            DriverStatus @default(ACTIVE)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  // Relations
  user       User       @relation(fields: [userId], references: [id])
  dispatches Dispatch[]

  @@map("drivers")
}

model Dispatch {
  id           String   @id @default(uuid())
  shipmentId   String   @unique // 1 shipment = 1 dispatch
  vehicleId    String
  driverId     String
  assignedAt   DateTime @default(now())
  assignedById String
  notes        String?  @db.Text
  createdAt    DateTime @default(now())

  // Relations
  shipment   Shipment @relation(fields: [shipmentId], references: [id])
  vehicle    Vehicle  @relation(fields: [vehicleId], references: [id])
  driver     Driver   @relation(fields: [driverId], references: [id])
  assignedBy User     @relation("AssignedBy", fields: [assignedById], references: [id])

  @@map("dispatches")
}

model ShipmentStatusEvent {
  id          String     @id @default(uuid())
  shipmentId  String
  status      ShipmentStatus
  eventType   EventType
  description String
  location    String?
  createdById String
  createdAt   DateTime   @default(now())

  // Relations
  shipment  Shipment @relation(fields: [shipmentId], references: [id])
  createdBy User     @relation(fields: [createdById], references: [id])

  @@map("shipment_status_events")
  @@index([shipmentId, createdAt])
}

model POD {
  id           String      @id @default(uuid())
  shipmentId   String
  stopId       String?
  fileName     String
  filePath     String // URL to external storage
  fileType     PODFileType
  fileSize     Int // bytes, max 5MB
  uploadedById String
  uploadedAt   DateTime    @default(now())
  isSubmitted  Boolean     @default(false) // Immutable after true

  // Relations
  shipment   Shipment      @relation(fields: [shipmentId], references: [id])
  stop       ShipmentStop? @relation(fields: [stopId], references: [id])
  uploadedBy User          @relation(fields: [uploadedById], references: [id])

  @@map("pods")
  @@index([shipmentId, isSubmitted])
}

model Debt {
  id                  String     @id @default(uuid())
  customerId          String
  
  // Debt Information
  debtType            DebtType
  debtMonth           String     // Format: "YYYY-MM" (e.g., "2026-02")
  amount              Decimal    @db.Decimal(15, 2) // Số tiền công nợ
  
  // Documents & References
  documentLink        String?    @db.Text // Link to Google Sheet/bảng kê
  invoiceImages       String[]   // Array of image URLs (hóa đơn)
  notes               String?    @db.Text
  
  // Dates
  recognitionDate     DateTime   @default(now()) // Ngày ghi nhận công nợ
  dueDate             DateTime   // Ngày đến hạn (auto calculated)
  
  // Payment Status
  status              DebtStatus @default(UNPAID)
  paidAmount          Decimal?   @db.Decimal(15, 2) // Số tiền đã thanh toán
  paidDate            DateTime?  // Ngày thanh toán
  paymentProofImages  String[]   // Array of UNC images
  paymentNotes        String?    @db.Text
  
  // Metadata
  createdById         String
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  deletedAt           DateTime?  // Soft delete

  // Relations
  customer            Customer   @relation(fields: [customerId], references: [id])
  createdBy           User       @relation("DebtCreatedBy", fields: [createdById], references: [id])

  @@map("debts")
  @@index([customerId, debtMonth])
  @@index([status, dueDate])
  @@index([debtMonth])
}
